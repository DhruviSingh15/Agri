<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container py-5">
        <h2 class="mb-4">Admin Panel</h2>
        <!-- Dashboard summary -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card text-bg-primary mb-3"><div class="card-body"><h5 class="card-title">Users</h5><p class="card-text fs-4">{{ users|length }}</p></div></div>
          </div>
          <div class="col-md-4">
            <div class="card text-bg-success mb-3"><div class="card-body"><h5 class="card-title">Listings</h5><p class="card-text fs-4">{{ listings|length }}</p></div></div>
          </div>
          <div class="col-md-4">
            <div class="card text-bg-warning mb-3"><div class="card-body"><h5 class="card-title">Offers</h5><p class="card-text fs-4">{{ offers|length }}</p></div></div>
          </div>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        <ul class="nav nav-tabs mb-4" id="adminTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Users</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="listings-tab" data-bs-toggle="tab" data-bs-target="#listings" type="button" role="tab">Crop Listings</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="offers-tab" data-bs-toggle="tab" data-bs-target="#offers" type="button" role="tab">Offers</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="announce-tab" data-bs-toggle="tab" data-bs-target="#announce" type="button" role="tab">Announcement</button>
          </li>
        </ul>
        <div class="tab-content" id="adminTabContent">
          <!-- Users Tab -->
          <div class="tab-pane fade show active" id="users" role="tabpanel">
            <h4>All Users</h4>
            <table class="table table-bordered table-sm">
              <thead><tr><th>Username</th><th>Email</th><th>Remove</th></tr></thead>
              <tbody>
                {% if users|length == 0 %}
                <tr><td colspan="3" class="text-center text-muted">No users found.</td></tr>
                {% else %}
                {% for user in users %}
                <tr>
                  <td>{{ user.username }}</td>
                  <td>{{ user.email }}</td>
                  <td>{% if user.username|lower != 'hari' %}<form method="post" style="display:inline;"><input type="hidden" name="remove_user" value="{{ user.id }}"><button class="btn btn-danger btn-sm" onclick="return confirm('Remove this user?');">Remove</button></form>{% else %}<span class="text-muted">Admin</span>{% endif %}</td>
                </tr>
                {% endfor %}
                {% endif %}
              </tbody>
            </table>
          </div>
          <!-- Listings Tab -->
          <div class="tab-pane fade" id="listings" role="tabpanel">
            <h4>All Crop Listings</h4>
            <table class="table table-bordered table-sm">
              <thead><tr><th>Crop</th><th>Quantity</th><th>Price</th><th>User</th><th>Remove</th></tr></thead>
              <tbody>
                {% if listings|length == 0 %}
                <tr><td colspan="5" class="text-center text-muted">No listings found.</td></tr>
                {% else %}
                {% for l in listings %}
                <tr>
                  <td>{{ l.crop }}</td>
                  <td>{{ l.quantity }}</td>
                  <td>{{ l.price }}</td>
                  <td>{{ l.user.username }}</td>
                  <td><form method="post" style="display:inline;"><input type="hidden" name="remove_listing" value="{{ l.id }}"><button class="btn btn-danger btn-sm" onclick="return confirm('Remove this listing?');">Remove</button></form></td>
                </tr>
                {% endfor %}
                {% endif %}
              </tbody>
            </table>
          </div>
          <!-- Offers Tab -->
          <div class="tab-pane fade" id="offers" role="tabpanel">
            <h4>All Offers</h4>
            <table class="table table-bordered table-sm">
              <thead><tr><th>Offer Price</th><th>Listing</th><th>By User</th><th>Remove</th></tr></thead>
              <tbody>
                {% if offers|length == 0 %}
                <tr><td colspan="4" class="text-center text-muted">No offers available.</td></tr>
                {% else %}
                {% for o in offers %}
                <tr>
                  <td>{{ o.offer_price }}</td>
                  <td>{{ o.listing.crop }} ({{ o.listing.user.username }})</td>
                  <td>{{ o.user.username }}</td>
                  <td><form method="post" style="display:inline;"><input type="hidden" name="remove_offer" value="{{ o.id }}"><button class="btn btn-danger btn-sm" onclick="return confirm('Remove this offer?');">Remove</button></form></td>
                </tr>
                {% endfor %}
                {% endif %}
              </tbody>
            </table>
          </div>
          <!-- Announcement Tab -->
          <div class="tab-pane fade" id="announce" role="tabpanel">
            <h4>Announcement</h4>
            <form method="post">
              <div class="mb-3">
                <label for="announcement" class="form-label">Edit Announcement</label>
                <textarea class="form-control" id="announcement" name="announcement" rows="3">{{ announcement }}</textarea>
              </div>
              <button type="submit" class="btn btn-primary">Save Announcement</button>
            </form>
            <div class="mt-3">
              <strong>Current Announcement:</strong>
              <div class="alert alert-info mt-2">{{ announcement if announcement else 'No announcement at this time.' }}</div>
            </div>
          </div>
        </div>
    </div>
</body>
</html>
